apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: regisration
spec:
  steps:
  - name: Create RegistrationRequest
    try:
    - apply:
        resource:
          apiVersion: product.webshop.harikube.info/v1
          kind: RegistrationRequest
          metadata:
            name: tech-innovators-inc
          spec:
            user:
              firstName: John
              lastName: D'oe-Smith
              email: john.doe@example.com
              phoneNumber: '+15551234567'
            password: Password123!
            tenant:
              companyName: Tech Innovators Inc. 
              country: USA
              city: New York
              address: 123 Main St, Apt 4B
              postalCode: '10001'
              taxNumber: ABC-123456789
    #     outputs:
    #     - name: request
    #       match:
    #         apiVersion: product.webshop.harikube.info/v1
    #         kind: RegistrationRequest
    #         name: tech-innovators-inc
    #       value: (@)
    #     - name: user
    #       match:
    #         apiVersion: product.webshop.harikube.info/v1
    #         kind: User
    #         name: tech-innovators-inc
    #         namespace: ($request.metadata.uid)
    #       value: (@)
    # - assert:
    #     resource:
    #       apiVersion: v1
    #       kind: Namespace
    #       metadata:
    #         name: ($request.metadata.uid)
    # - assert:
    #     resource:
    #       apiVersion: product.webshop.harikube.info/v1
    #       kind: Tenant
    #       metadata:
    #         name: tech-innovators-inc
    #         ownerReferences:
    #         - apiVersion: v1
    #           kind: Namespace
    #           name: tech-innovators-inc
    #           blockOwnerDeletion: true
    #         finalizers:
    #         - product.webshop.harikube.info/tenant
    #       spec:
    #         companyName: Tech Innovators Inc. 
    #         country: USA
    #         city: New York
    #         address: 123 Main St, Apt 4B
    #         postalCode: '10001'
    #         taxNumber: ABC-123456789
    # - assert:
    #     resource:
    #       apiVersion: product.webshop.harikube.info/v1
    #       kind: User
    #       metadata:
    #         name: tech-innovators-inc
    #       spec:
    #         firstName: John
    #         lastName: D'oe-Smith
    #         email: john.doe@example.com
    #         phoneNumber: '+15551234567'
    #       status:
    #         passwordRef:
    #           name: tech-innovators-inc
    # - assert:
    #     resource:
    #       apiVersion: v1
    #       kind: Secret
    #       metadata:
    #         name: tech-innovators-inc
    #         ownerReferences:
    #         - apiVersion: product.webshop.harikube.info/v1
    #           kind: User
    #           name: tech-innovators-inc
    #       stringData:
    #         passwordHash: 12345
    # - assert:
    #     resource:
    #       apiVersion: rbac.authorization.k8s.io
    #       kind: Role
    #       metadata:
    #         name: ($user.metadata.uid)
    #         ownerReferences:
    #         - apiVersion: product.webshop.harikube.info/v1
    #           kind: User
    #           name: tech-innovators-inc
    #       rules:
    #       - apiGroups:
    #         - product.webshop.harikube.info
    #         resources:
    #         - orders
    #         verbs:
    #         - get
    #         - list
    #         - watch
    #       - apiGroups:
    #         - product.webshop.harikube.info
    #         resources:
    #         - registrytokens
    #         verbs:
    #         - get
    #         - list
    #         - watch
    #         - create
    #         - delete
    #       - apiGroups:
    #         - product.webshop.harikube.info
    #         resources:
    #         - tenants
    #         verbs:
    #         - get
    #         - list
    #         - watch
    #         - update
    #         - patch
    #       - apiGroups:
    #         - product.webshop.harikube.info
    #         resources:
    #         - users
    #         resourceNames:
    #         - ($user.metadata.uid)
    #         verbs:
    #         - get
    #         - list
    #         - watch
    #         - update
    #         - patch
    # - assert:
    #     resource:
    #       apiVersion: rbac.authorization.k8s.io
    #       kind: RoleBinding
    #       metadata:
    #         name: ($user.metadata.uid)
    #         ownerReferences:
    #         - apiVersion: product.webshop.harikube.info/v1
    #           kind: User
    #           name: tech-innovators-inc
    #       subjects:
    #       - kind: ServiceAccount
    #         name: ($user.metadata.uid)
    #         namespace: ($request.metadata.uid)
    #       roleRef:
    #         apiGroup: rbac.authorization.k8s.io
    #         kind: Role
    #         name: ($user.metadata.uid)
    # - assert:
    #     resource:
    #       apiVersion: v1
    #       kind: ServiceAccount
    #       metadata:
    #         name: ($user.metadata.uid)
    #         ownerReferences:
    #         - apiVersion: product.webshop.harikube.info/v1
    #           kind: User
    #           name: tech-innovators-inc
