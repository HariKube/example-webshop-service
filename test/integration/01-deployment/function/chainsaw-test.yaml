apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: function
spec:
  namespace: default
  skipDelete: true
  timeouts:
    exec: 5m
  steps:
  - name: Deploy function
    try:
    - sleep:
        duration: 5s
    - script:
        content: kubectl get secret -n openfaas basic-auth -o jsonpath='{.data.basic-auth-password}'| base64 -d
        outputs:
        - name: passwd
          value: ($stdout)
    - script:
        content: cd ../../../../function ; ../bin/faas-cli login --password ${PASSWD} --gateway http://localhost:32767
        env:
        - name: PASSWD
          value: ($passwd)
    - script:
        content: cd ../../../../function ; ../bin/faas-cli deploy --gateway http://localhost:32767
    - script:
        content: |
          kubectl patch deployment email -n example-webshop-service-system --type='json' \
            -p='[{"op": "replace", "path": "/spec/template/spec/serviceAccountName", "value": "example-webshop-service-controller-manager"}]'
    - script:
        content: kubectl rollout status deployment/email -n example-webshop-service-system --timeout=60s
    - assert:
        resource:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: email
            namespace: example-webshop-service-system
          status:
            readyReplicas: 1
